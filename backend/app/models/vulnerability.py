"""
Vulnerability database model
"""
from sqlalchemy import Column, String, Integer, Text, JSON, Enum as SQLEnum, ForeignKey
from sqlalchemy.orm import relationship
import uuid
import enum

from app.core.database import Base


class VulnerabilitySeverity(str, enum.Enum):
    """Vulnerability severity levels"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class ExploitabilityLevel(str, enum.Enum):
    """How easy is it to exploit this vulnerability"""
    TRIVIAL = "trivial"
    EASY = "easy"
    MODERATE = "moderate"
    DIFFICULT = "difficult"
    THEORETICAL = "theoretical"


class Vulnerability(Base):
    """
    Vulnerability model - represents a single security vulnerability found in a contract
    """
    __tablename__ = "vulnerabilities"

    # Primary key
    id = Column(String, primary_key=True, default=lambda: str(uuid.uuid4()))

    # Foreign key to audit
    audit_id = Column(String, ForeignKey("audits.id", ondelete="CASCADE"), nullable=False)

    # Vulnerability classification
    rule_id = Column(String, nullable=True)  # e.g., SEN-001
    title = Column(String, nullable=False)
    severity = Column(SQLEnum(VulnerabilitySeverity), nullable=False)
    exploitability = Column(SQLEnum(ExploitabilityLevel), nullable=True)
    category = Column(String, nullable=True)  # e.g., "security", "gas", "best_practice"

    # Location in code
    file_name = Column(String, nullable=True)
    line_number = Column(Integer, nullable=True)
    function_name = Column(String, nullable=True)
    code_snippet = Column(Text, nullable=True)

    # Vulnerability details
    description = Column(Text, nullable=False)
    exploit_scenario = Column(Text, nullable=True)
    recommendation = Column(Text, nullable=True)
    fixed_code = Column(Text, nullable=True)

    # Additional metadata
    cwe_id = Column(String, nullable=True)  # Common Weakness Enumeration
    swc_id = Column(String, nullable=True)  # Smart Contract Weakness Classification
    references = Column(JSON, nullable=True)  # List of reference URLs

    # Detection method
    detected_by = Column(String, nullable=True)  # "static", "ai", "rule_engine"
    confidence = Column(Integer, default=100)  # 0-100

    # Relationships
    audit = relationship("Audit", back_populates="vulnerabilities")

    def __repr__(self):
        return f"<Vulnerability(id={self.id}, title={self.title}, severity={self.severity})>"

    def to_dict(self):
        """Convert to dictionary"""
        return {
            "id": self.id,
            "audit_id": self.audit_id,
            "rule_id": self.rule_id,
            "title": self.title,
            "severity": self.severity.value,
            "exploitability": self.exploitability.value if self.exploitability else None,
            "category": self.category,
            "file_name": self.file_name,
            "line_number": self.line_number,
            "function_name": self.function_name,
            "code_snippet": self.code_snippet,
            "description": self.description,
            "exploit_scenario": self.exploit_scenario,
            "recommendation": self.recommendation,
            "fixed_code": self.fixed_code,
            "cwe_id": self.cwe_id,
            "swc_id": self.swc_id,
            "references": self.references,
            "detected_by": self.detected_by,
            "confidence": self.confidence,
        }
